name: Release Tauri Apps

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  PNPM_VERSION: 10.18.2
  NODE_VERSION: 20

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate routes
        run: pnpm core:gen-routes

      - name: Build Windows Tauri bundle
        run: pnpm windows:build

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: frontend/app/windows/src-tauri/target/release/bundle/**/*.msi
          if-no-files-found: error

  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Set up Rust for Android targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0
            ndk;26.1.10909125
            cmake;3.22.1

      - name: Configure Android environment variables
        shell: bash
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/26.1.10909125" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate routes
        run: pnpm core:gen-routes

      - name: Prepare Android keystore
        shell: bash
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_RELEASE_JKS_BASE64 }}
        run: |
          mkdir -p "$RUNNER_TEMP/keystore"
          printf '%s' "$KEYSTORE_BASE64" | base64 -d > "$RUNNER_TEMP/keystore/release.jks"
          # エイリアスが異なる場合は以下の値を別途更新してください
          ANDROID_KEY_ALIAS="app-release"
          {
            echo "TAURI_ANDROID_KEYSTORE_PATH=$RUNNER_TEMP/keystore/release.jks"
            echo "TAURI_ANDROID_KEYSTORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD }}"
            echo "TAURI_ANDROID_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}"
            echo "TAURI_ANDROID_KEY_ALIAS=$ANDROID_KEY_ALIAS"
          } >> "$GITHUB_ENV"

      - name: Build Android Tauri bundle
        run: pnpm android:build

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            frontend/app/android/src-tauri/gen/android/app/build/outputs/**/*.apk
            frontend/app/android/src-tauri/gen/android/app/build/outputs/**/*.aab
          if-no-files-found: error

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    environment: release
    needs:
      - build-windows
      - build-android
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-msi
          path: dist/windows

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-artifacts
          path: dist/android

      - name: List collected artifacts
        run: ls -R dist

      - name: Create GitHub Release (draft & prerelease)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: tauri-${{ github.ref_name }}-${{ github.run_number }}
          name: Tauri build ${{ github.ref_name }} #${{ github.run_number }}
          draft: true
          prerelease: true
          files: |
            dist/windows/**
            dist/android/**
