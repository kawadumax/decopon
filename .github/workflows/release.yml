name: Release Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  PNPM_VERSION: 10.18.2
  NODE_VERSION: 20

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Read version
        id: windows_version
        shell: pwsh
        run: |
          $version = (Get-Content VERSION -Raw).Trim()
          "app_version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate routes
        run: pnpm core:gen-routes

      - name: Build Windows Tauri bundle
        run: pnpm windows:build

      - name: Rename Windows installers
        shell: pwsh
        env:
          APP_VERSION: ${{ steps.windows_version.outputs.app_version }}
        run: |
          $bundleRoot = "frontend/app/windows/src-tauri/target/release/bundle"
          $targets = Get-ChildItem -Path $bundleRoot -Recurse -Include *.msi, *.exe
          if (-not $targets) {
            throw "No Windows installer artifacts were found under $bundleRoot"
          }
          foreach ($file in $targets) {
            $extension = $file.Extension.ToLowerInvariant()
            if ($extension -eq ".msi") {
              $destName = "Decopon.Win.v$env:APP_VERSION.msi"
            } elseif ($extension -eq ".exe") {
              $destName = "Decopon.Win.v$env:APP_VERSION.exe"
            } else {
              continue
            }
            $destination = Join-Path $file.DirectoryName $destName
            Move-Item -Path $file.FullName -Destination $destination -Force
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: |
            frontend/app/windows/src-tauri/target/release/bundle/**/Decopon.Win.v*.msi
            frontend/app/windows/src-tauri/target/release/bundle/**/Decopon.Win.v*.exe
          if-no-files-found: error

  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Read version
        id: android_version
        run: |
          APP_VERSION=$(tr -d '\r\n' < VERSION)
          echo "app_version=$APP_VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Set up Rust for Android targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: "platform-tools platforms;android-34 build-tools;34.0.0 ndk;26.1.10909125 cmake;3.22.1"

      - name: Configure Android environment variables
        shell: bash
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/26.1.10909125" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate routes
        run: pnpm core:gen-routes

      - name: Prepare Android keystore
        shell: bash
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_RELEASE_JKS_BASE64 }}
        run: |
          mkdir -p "$RUNNER_TEMP/keystore"
          printf '%s' "$KEYSTORE_BASE64" | base64 -d > "$RUNNER_TEMP/keystore/release.jks"
          # エイリアスが異なる場合は以下の値を別途更新してください
          ANDROID_KEY_ALIAS="app-release"
          {
            echo "TAURI_ANDROID_KEYSTORE_PATH=$RUNNER_TEMP/keystore/release.jks"
            echo "TAURI_ANDROID_KEYSTORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD }}"
            echo "TAURI_ANDROID_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}"
            echo "TAURI_ANDROID_KEY_ALIAS=$ANDROID_KEY_ALIAS"
          } >> "$GITHUB_ENV"

      - name: Build Android Tauri bundle
        run: pnpm android:build
        env:
          # ARM64 専用ビルドに限定
          TAURI_ANDROID_TARGETS: aarch64

      - name: Rename Android APK
        env:
          APP_VERSION: ${{ steps.android_version.outputs.app_version }}
        run: |
          set -euo pipefail
          APK_ROOT="frontend/app/android/src-tauri/gen/android/app/build/outputs"
          mapfile -t APK_FILES < <(find "$APK_ROOT" -type f -name '*.apk' ! -name '*-unsigned*' ! -name '*-debug*' | sort)
          if [ "${#APK_FILES[@]}" -eq 0 ]; then
            echo "Signed APK was not found under $APK_ROOT" >&2
            find "$APK_ROOT" -type f -name '*.apk' -print >&2 || true
            exit 1
          fi
          SELECTED=""
          for apk in "${APK_FILES[@]}"; do
            base_name=$(basename "$apk")
            if [[ "$base_name" == *"-universal-"* ]]; then
              SELECTED="$apk"
              break
            fi
          done
          if [ -z "$SELECTED" ]; then
            SELECTED="${APK_FILES[0]}"
          fi
          TARGET_DIR=$(dirname "$SELECTED")
          TARGET="$TARGET_DIR/Decopon.Android.v${APP_VERSION}.apk"
          mv "$SELECTED" "$TARGET"

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            frontend/app/android/src-tauri/gen/android/app/build/outputs/**/Decopon.Android.v*.apk
          if-no-files-found: error

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    environment: release
    needs:
      - build-windows
      - build-android
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-msi
          path: dist/windows

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-artifacts
          path: dist/android

      - name: List collected artifacts
        run: ls -R dist

      - name: Read version
        id: version
        run: |
          APP_VERSION=$(tr -d '\r\n' < VERSION)
          echo "app_version=$APP_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.app_version }}
          name: Decopon v${{ steps.version.outputs.app_version }}
          draft: false
          prerelease: true
          files: |
            dist/windows/**
            dist/android/**
