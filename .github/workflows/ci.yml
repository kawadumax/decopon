name: CI

# Pull Requestに対してトリガー
on:
  pull_request:
    branches:
      - dev
      - main
jobs:
  backend-check:
    name: Backend Checks
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies for Tauri crates
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            pkg-config
          sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2

      - name: Cargo check (services crate)
        run: cargo check --manifest-path backend/services/Cargo.toml --all-targets

      - name: Cargo check (runtime crate)
        run: cargo check --manifest-path backend/runtime/Cargo.toml --all-targets

      - name: Cargo check (axum default features)
        run: cargo check --manifest-path backend/axum/Cargo.toml --all-targets

      - name: Cargo check (axum web feature)
        run: cargo check --manifest-path backend/axum/Cargo.toml --no-default-features --features web --all-targets

      - name: Cargo check (migration crate)
        run: cargo check --manifest-path backend/axum/migration/Cargo.toml

      - name: Cargo check (app IPC crate)
        run: cargo check --manifest-path frontend/app/ipc/Cargo.toml

      - name: Cargo check (windows tauri crate)
        run: cargo check --manifest-path frontend/app/windows/src-tauri/Cargo.toml

      - name: Cargo check (android tauri crate)
        run: cargo check --manifest-path frontend/app/android/src-tauri/Cargo.toml

  frontend-typecheck:
    name: Frontend Type Checks
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.2 # pnpm@10.18.2 (packageManagerに整合)
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20  # Node.jsのバージョンを指定
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate routes
        run: pnpm core:gen-routes

      - name: Emit core type declarations
        run: pnpm exec tsc --pretty false --project frontend/core/tsconfig.json --emitDeclarationOnly

      - name: Type check packages
        run: |
          pnpm exec tsc --pretty false --noEmit --project frontend/web/tsconfig.json
          pnpm exec tsc --pretty false --noEmit --project frontend/app/shared/tsconfig.json
          pnpm exec tsc --pretty false --noEmit --project frontend/app/windows/tsconfig.json --rootDir frontend/app/shared
          pnpm exec tsc --pretty false --noEmit --project frontend/app/android/tsconfig.json --rootDir frontend/app/shared
          pnpm exec tsc --pretty false --noEmit --project sites/tsconfig.json
